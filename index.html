<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ULTRA</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root {
      --dark-taupe: #A59D84;
      --light-taupe: #C1BAA1;
      --pale-taupe: #D7D3BF;
      --off-white: #ECEBDE;
    }
    
    body {
      font-family: 'Times New Roman', serif;
      background-color: var(--off-white);
      color: #333;
    }
    
    .navbar {
      background-color: #dfd7b8c4;
      padding: 1.5rem 0;
    }
    
    .navbar-brand {
      font-size: 2rem;
      font-weight: bold;
      letter-spacing: 3px;
      color: #fff !important;
      text-transform: uppercase;
    }
    
    .nav-link {
      color: #000 !important;
      font-size: 1.1rem;
      margin: 0 1rem;
      text-transform: none;
      letter-spacing: 0.5px;
    }
    
    .hero-section {
      height: 100vh;
      background-position: center;
      background-size:100%;
      position: relative;
    }
    
    .section-title {
      text-align: center;
      font-size: 2rem;
      margin: 3rem 0 2rem;
      position: relative;
      letter-spacing: 1px;
    }
    
    .section-title:after {
      content: "";
      display: block;
      width: 50px;
      height: 2px;
      background-color: var(--dark-taupe);
      margin: 1rem auto;
    }
    
    .product-card {
      border: none;
      background-color: transparent;
      margin-bottom: 2rem;
      transition: transform 0.3s;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
    }
    
    .product-card .card-title {
      font-size: 0.9rem;
      text-align: center;
      margin-top: 0.5rem;
      font-weight: normal;
    }
    
    .product-card .card-text {
      font-size: 0.8rem;
      text-align: center;
      color: var(--dark-taupe);
    }
    
    .collection-section {
      background-color: var(--pale-taupe);
      padding: 10rem 0;
      text-align: center;
      position: relative;
    }
    
    .collection-title {
      font-size: 4rem;
      color: white;
      letter-spacing: 5px;
      margin-bottom: 2rem;
    }
    
    .view-btn {
      color: white;
      border: 1px solid white;
      padding: 0.5rem 2rem;
      text-transform: uppercase;
      font-size: 0.8rem;
      background: transparent;
      letter-spacing: 2px;
    }
    
    .cozy-section {
      padding: 4rem 0;
      background-color: white;
    }
    
    .cozy-title {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .cozy-title:after {
      content: "";
      display: block;
      width: 30px;
      height: 2px;
      background-color: var(--dark-taupe);
      margin-top: 0.5rem;
    }
    
    .cozy-text {
      font-size: 0.9rem;
      line-height: 1.6;
    }
    
    footer {
      background-color: var(--off-white);
      padding: 4rem 0 2rem;
      font-size: 0.85rem;
    }
    
    .footer-title {
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    
    .footer-links p {
      margin-bottom: 0.5rem;
    }
    
    .footer-divider {
      height: 1px;
      background-color: var(--light-taupe);
      margin: 2rem 0 1rem;
    }
    
    .footer-bottom {
      font-size: 0.75rem;
      color: #888;
    }
    
    .cart-btn {
      position: relative;
      margin-left: 10px;
    }
    
    .cart-count, .history-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--dark-taupe);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.7rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bestseller-card {
      position: static;
      margin-bottom: 2rem;
      overflow: hidden;
      border: none;
      background-color: transparent;
      transition: transform 0.3s;
    }
    
    .bestseller-card:hover {
      transform: translateY(-5px);
    }
    
    .bestseller-card .card-title {
      font-size: 0.9rem;
      text-align: center;
      margin-top: 0.5rem;
      font-weight: normal;
    }
    
    .bestseller-card .card-text {
      font-size: 0.8rem;
      text-align: center;
      color: var (--dark-taupe);
    }
    
    .bestseller-card .btn {
      display: block;
      margin: 0 auto;
      margin-top: 0.5rem;
    }

    .quantity-selector {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 1rem 0;
    }
    
    .quantity-btn {
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 1px solid #ddd;
      background: white;
      font-size: 1rem;
      cursor: pointer;
    }
    
    .quantity-input {
      width: 50px;
      height: 30px;
      text-align: center;
      border: 1px solid #ddd;
      margin: 0 0.5rem;
    }

    .total-price {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    .cozy-section .row {
      align-items: stretch;
    }
    .bestseller-card {
      margin-top: 14rem;
      height: 50%;
      width: 60%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .bestseller-card .card-img-top {
      height: 25rem;
      object-fit: cover;
    }

    #bestseller-row {
      height: 20rem !important;
    }
    @media (min-width: 768px) {
      #bestseller-row .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 1.5rem;
      }
      #bestseller-row {
        display: flex;
        flex-direction: column;
        justify-content: center;
        height: 100%;
      }
      .cozy-section .col-md-8 {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .cozy-section .col-md-4 {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .bestseller-card {
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }
    }
    /* Tambahkan style untuk scroll horizontal pada modal kategori */
    #categoryModalBody {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 1rem;
      padding-bottom: 1rem;
    }
    #categoryModalBody .col-md-4 {
      min-width: 270px;
      flex: 0 0 auto;
    }
    /* Sembunyikan scrollbar di Webkit */
    #categoryModalBody::-webkit-scrollbar {
      height: 8px;
      background: #ecebde;
    }
    #categoryModalBody::-webkit-scrollbar-thumb {
      background: #d7d3bf;
      border-radius: 4px;
    }

    .shadow{
      filter: drop-shadow(0 0 10px black);
    }
  </style>
</head>
<body>

  <!-- Hero Section -->
  <section class="hero-section" style="background-image: url('img/bg_main.jpg'); background-position: left bottom;">
      <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand mx-auto" href="#">MIX SHOES</a>
      <div class="collapse navbar-collapse justify-content-center">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="#">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Latest Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Sneakers</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Heels</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Sport</a>
          </li>
          <!-- Dashboard nav link -->
          <li class="nav-item" id="dashboardNav" style="display:none">
            <a class="nav-link" href="./dashboard/index.html">Dashboard</a>
          </li>
          <li class="nav-item">
            <button id="authButton" class="btn btn-outline-light shadow">Sign In</button>
          </li>
          <li class="nav-item">
            <a href="./cart.html" class="btn btn-outline-light shadow cart-btn">
              <i class="bi bi-cart"></i>
              <span class="cart-count" id="cartCount">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="./history.html" class="btn btn-outline-light shadow cart-btn">
              <i class="bi bi-clock-history"></i>
              <span class="history-count" id="historyCount">0</span>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  </section>

  <!-- New Arrivals Section -->
  <section class="container">
    <h2 class="section-title">Latest Products</h2>
    <div class="row">
      <!-- Latest products will be loaded here -->
    </div>
  </section>

  <!-- Collection Section -->
  <section class="collection-section mt-5" style="background: url('img/bg_sneakers.jpg'); background-size: cover; background-position: bottom ;">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h2 class="collection-title">Sneakers</h2>
          <button class="view-btn btn btn-outline-dark">VIEW</button>
        </div>
      </div>
    </div>
  </section>
  <section class="collection-section" style="background: url('img/bg_heels.jpg'); background-size: cover; background-position: center -78rem ;">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h2 class="collection-title">Heels</h2>
          <button class="view-btn btn btn-outline-dark">VIEW</button>
        </div>
      </div>
    </div>
  </section>
  <section class="collection-section" style="background: url('img/bg_sport.jpg'); background-size: cover; background-position: center -70rem ;">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h2 class="collection-title">Sport</h2>
          <button class="view-btn btn btn-outline-dark">VIEW</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Best Sellers Section (Previously Cozy Section) -->
  <section class="cozy-section">
    <div class="container">
      <div class="row">
        <div class="col-12 col-md-8 d-flex flex-column justify-content-center">
          <div class="row" id="bestseller-row">
            <div class="col-md-6">
              <div class="card product-card bestseller-card">
                <img src="/api/placeholder/400/500" class="card-img-top bestseller-img" alt="Best Seller1">
                <div class="card-body px-0 py-2">
                  <h5 class="card-title bestseller-title">Loading...</h5>
                  <p class="card-text bestseller-price">Loading...</p>
                  <button class="btn btn-sm btn-outline-dark add-to-cart-bestseller" data-id="">Add to Cart</button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card product-card bestseller-card">
                <img src="/api/placeholder/400/500" class="card-img-top bestseller-img" alt="Best Seller2">
                <div class="card-body px-0 py-2">
                  <h5 class="card-title bestseller-title">Loading...</h5>
                  <p class="card-text bestseller-price">Loading...</p>
                  <button class="btn btn-sm btn-outline-dark add-to-cart-bestseller" data-id="">Add to Cart</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-4 d-flex flex-column justify-content-center">
          <h3 class="cozy-title">Trending Shoes</h3>
          <p class="cozy-text">
            Shop the latest collection of stunning designs. Discover new favorites in women's clothing. Find everything from casual day dresses to sharp office wear. We have jeans in every fit, premium quality items and the latest fashion essentials.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-md-4 footer-links">
          <h4 class="footer-title">About Us</h4>
          <p>Our Story</p>
          <p>Our Spirit</p>
          <p>Our Member</p>
        </div>
        <div class="col-md-4 footer-links">
          <h4 class="footer-title">Customer Service</h4>
          <p>Contact Us</p>
          <p>Delivery Options</p>
          <p>Payment Methods</p>
        </div>
        <div class="col-md-4 footer-links">
          <h4 class="footer-title">Call Us</h4>
          <p>Tel / 02-1234-5678</p>
          <p>Time / AM 08:00 - PM 10:00</p>
          <p>Email / ultrahelp@shoplineapp.com</p>
        </div>
      </div>
      <div class="footer-divider"></div>
      <div class="footer-bottom text-center">
        Privacy Policy | Terms & Conditions | 2020 © Your Brand
      </div>
    </div>
  </footer>

  <!-- Modal untuk kategori -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row" id="categoryModalBody"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_API = 'https://be-pkk-production.up.railway.app/api';

    // Helper: format rupiah
    function formatRupiah(num) {
      return 'Rp ' + Number(num).toLocaleString('id-ID');
    }

    // Check login status and update UI
    async function checkLoginStatus() {
      const token = localStorage.getItem('token');
      const authButton = document.getElementById('authButton');
      const dashboardNav = document.getElementById('dashboardNav');
      let isAdmin = false;

      if (token) {
        try {
          // Fetch user info from /api/me
          const res = await fetch('https://be-pkk-production.up.railway.app/api/me', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          if (res.ok) {
            const data = await res.json();
            // Cek jika username === 'admin'
            if (data && data.role === 'admin') {
              isAdmin = true;
            }
          }
        } catch {}
      }

      if (token) {
        // User is logged in
        authButton.innerHTML = '<i class="bi bi-box-arrow-right"></i>';
        authButton.onclick = function() {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          Swal.fire({
            title: 'Signed Out',
            text: 'You have been signed out successfully',
            icon: 'success',
            confirmButtonColor: '#A59D84' 
          }).then(() => {
            checkLoginStatus();
          });
        };
        // Show dashboard nav only for admin
        if (isAdmin) {
          dashboardNav.style.display = '';
        } else {
          dashboardNav.style.display = 'none';
        }
      } else {
        // User is not logged in
        authButton.textContent = 'Sign In';
        authButton.onclick = function() {
          window.location.href = './login.html';
        };
        dashboardNav.style.display = 'none';
      }
      updateCartCount();
      updateHistoryCount();
    }

    // Update cart count
    async function updateCartCount() {
      const cartCount = document.getElementById('cartCount');
      const token = localStorage.getItem('token');
      if (!token) {
        cartCount.textContent = '0';
        return;
      }
      try {
        const res = await fetch(`${BASE_API}/cart`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!res.ok) {
          cartCount.textContent = '0';
          return;
        }
        const data = await res.json();
        // data bisa array langsung atau {data: array}
        const items = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
        cartCount.textContent = items.length;
      } catch (e) {
        cartCount.textContent = '0';
      }
    }

    // Update history count
    async function updateHistoryCount() {
      const historyCount = document.getElementById('historyCount');
      const token = localStorage.getItem('token');
      if (!token) {
        historyCount.textContent = '0';
        return;
      }
      try {
        // Ambil userId dari token JWT
        const payload = JSON.parse(atob(token.split('.')[1]));
        const userId = payload.id;

        const res = await fetch(`${BASE_API}/order`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!res.ok) {
          historyCount.textContent = '0';
          return;
        }
        const data = await res.json();
        // data bisa array langsung atau {data: array}
        const items = Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []);
        // Hanya hitung transaksi milik user login
        const userItems = items.filter(item => item.UserId == userId);
        historyCount.textContent = userItems.length;
      } catch (e) {
        historyCount.textContent = '0';
      }
    }

    // Latest Products
    async function loadLatestProducts() {
      const container = document.querySelector('.section-title + .row');
      container.innerHTML = '';
      try {
        const res = await fetch(`${BASE_API}/product`);
        const json = await res.json();
        let products = json.data || [];
        products = products.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 4);
        products.forEach(p => {
          container.innerHTML += `
            <div class="col-md-3">
              <div class="card product-card" data-name="${p.name}" data-price="${p.price}" data-img="${p.image}" data-id="${p.id}">
                <img src="${p.image || '/api/placeholder/300/400'}" class="card-img-top" alt="${p.name}">
                <div class="card-body px-0 py-2">
                  <h5 class="card-title">${p.name}</h5>
                  <p class="card-text">${formatRupiah(p.price)}</p>
                </div>
              </div>
            </div>
          `;
        });
        // Re-attach product card click event
        attachProductCardEvents();
      } catch (e) {
        container.innerHTML = '<div class="col-12 text-center text-danger">Failed to load products.</div>';
      }
    }

    // Add item to cart with API
    async function addToCartAPI(productId, quantity) {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          Swal.fire({
            title: 'Please Sign In',
            text: 'You need to be signed in to add items to cart',
            icon: 'warning',
            confirmButtonColor: '#A59D84',
            confirmButtonText: 'Sign In Now',
            showCancelButton: true,
            cancelButtonText: 'Later'
          }).then((result) => {
            if (result.isConfirmed) {
              window.location.href = './login.html';
            }
          });
          return false;
        }
        
        const response = await fetch(`${BASE_API}/cart`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            productId,
            quantity
          })
        });
        
        const data = await response.json();
        if (data.status === 'success') {
          // Also add to local storage for cart count display
          const cart = JSON.parse(localStorage.getItem('cart') || '[]');
          const existingItem = cart.findIndex(item => item.id === productId);
          
          if (existingItem >= 0) {
            cart[existingItem].quantity += quantity;
          } else {
            cart.push({
              id: productId,
              quantity
            });
          }
          
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartCount();
          return true;
        } else {
          throw new Error(data.message || 'Failed to add to cart');
        }
      } catch (error) {
        Swal.fire({
          title: 'Success',
          text: error.message || 'Failed to add item to cart',
          icon: 'success',
          confirmButtonColor: '#A59D84'
        });

        updateCartCount();
        return false;
      }
    }

    // Attach click event for product cards
    function attachProductCardEvents() {
      document.querySelectorAll('.product-card').forEach(card => {
        card.onclick = function() {
          const productId = this.getAttribute('data-id');
          const productName = this.getAttribute('data-name') || this.querySelector('.card-title').textContent;
          const productPrice = this.getAttribute('data-price');
          const formattedPrice = formatRupiah(productPrice);
          const img = this.getAttribute('data-img') || this.querySelector('img').src;
          
          // Create HTML for the modal content with quantity selector
          const modalContent = `
            <div class="text-center">
              <img src="${img}" style="max-height: 300px; max-width: 100%;" class="mb-3">
              <h5>${productName}</h5>
              <p>${formattedPrice}</p>
              
              <div class="quantity-selector">
                <button class="quantity-btn decrease">-</button>
                <input type="number" class="quantity-input" value="1" min="1" max="10">
                <button class="quantity-btn increase">+</button>
              </div>
              
              <div class="total-price">
                Total: ${formattedPrice}
              </div>
            </div>
          `;
          
          Swal.fire({
            title: 'Add to Cart',
            html: modalContent,
            showCancelButton: true,
            confirmButtonText: 'Add to Cart',
            confirmButtonColor: '#A59D84',
            cancelButtonText: 'Cancel',
            didOpen: () => {
              // Set up quantity selector functionality
              const decreaseBtn = document.querySelector('.decrease');
              const increaseBtn = document.querySelector('.increase');
              const quantityInput = document.querySelector('.quantity-input');
              const totalPriceDiv = document.querySelector('.total-price');
              
              const updateTotalPrice = () => {
                const quantity = parseInt(quantityInput.value);
                const total = quantity * productPrice;
                totalPriceDiv.textContent = `Total: ${formatRupiah(total)}`;
              };
              
              decreaseBtn.addEventListener('click', () => {
                let qty = parseInt(quantityInput.value);
                if (qty > 1) {
                  quantityInput.value = qty - 1;
                  updateTotalPrice();
                }
              });
              
              increaseBtn.addEventListener('click', () => {
                let qty = parseInt(quantityInput.value);
                if (qty < 10) {
                  quantityInput.value = qty + 1;
                  updateTotalPrice();
                }
              });
              
              quantityInput.addEventListener('change', () => {
                let qty = parseInt(quantityInput.value);
                if (isNaN(qty) || qty < 1) quantityInput.value = 1;
                if (qty > 10) quantityInput.value = 10;
                updateTotalPrice();
              });
            }
          }).then(async (result) => {
            if (result.isConfirmed) {
              const quantity = parseInt(document.querySelector('.quantity-input').value);
              
              // Add to cart using API
              const success = await addToCartAPI(productId, quantity);
              
              if (success) {
                Swal.fire({
                  title: 'Added to Cart!',
                  text: `${quantity} ${quantity > 1 ? 'items' : 'item'} of ${productName} added to your cart.`,
                  icon: 'success',
                  confirmButtonColor: '#A59D84'
                });
              }
            }
          });
        };
      });
    }

    // Attach add to cart event for bestseller products
    function attachBestSellerEvents() {
      document.querySelectorAll('.add-to-cart-bestseller').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.stopPropagation(); // Prevent parent card click
          
          const productId = this.getAttribute('data-id');
          const productName = this.closest('.bestseller-card').querySelector('.bestseller-title').textContent;
          const priceText = this.closest('.bestseller-card').querySelector('.bestseller-price').textContent;
          const img = this.closest('.bestseller-card').querySelector('img').src;
          
          // Create HTML for the modal content with quantity selector
          const modalContent = `
            <div class="text-center">
              <img src="${img}" style="max-height: 300px; max-width: 100%;" class="mb-3">
              <h5>${productName}</h5>
              <p>${priceText}</p>
              
              <div class="quantity-selector">
                <button class="quantity-btn decrease">-</button>
                <input type="number" class="quantity-input" value="1" min="1" max="10">
                <button class="quantity-btn increase">+</button>
              </div>
              
              <div class="total-price">
                Total: ${priceText}
              </div>
            </div>
          `;
          
          Swal.fire({
            title: 'Add to Cart',
            html: modalContent,
            showCancelButton: true,
            confirmButtonText: 'Add to Cart',
            confirmButtonColor: '#A59D84',
            cancelButtonText: 'Cancel',
            didOpen: () => {
              // Extract price number for calculations
              const priceNumber = parseInt(priceText.replace(/[^0-9]/g, ''));
              
              // Set up quantity selector functionality
              const decreaseBtn = document.querySelector('.decrease');
              const increaseBtn = document.querySelector('.increase');
              const quantityInput = document.querySelector('.quantity-input');
              const totalPriceDiv = document.querySelector('.total-price');
              
              const updateTotalPrice = () => {
                const quantity = parseInt(quantityInput.value);
                const total = quantity * priceNumber;
                totalPriceDiv.textContent = `Total: ${formatRupiah(total)}`;
              };
              
              decreaseBtn.addEventListener('click', () => {
                let qty = parseInt(quantityInput.value);
                if (qty > 1) {
                  quantityInput.value = qty - 1;
                  updateTotalPrice();
                }
              });
              
              increaseBtn.addEventListener('click', () => {
                let qty = parseInt(quantityInput.value);
                if (qty < 10) {
                  quantityInput.value = qty + 1;
                  updateTotalPrice();
                }
              });
              
              quantityInput.addEventListener('change', () => {
                let qty = parseInt(quantityInput.value);
                if (isNaN(qty) || qty < 1) quantityInput.value = 1;
                if (qty > 10) quantityInput.value = 10;
                updateTotalPrice();
              });
            }
          }).then(async (result) => {
            if (result.isConfirmed) {
              const quantity = parseInt(document.querySelector('.quantity-input').value);
              
              // Add to cart using API
              const success = await addToCartAPI(productId, quantity);
              
              if (success) {
                Swal.fire({
                  title: 'Added to Cart!',
                  text: `${quantity} ${quantity > 1 ? 'items' : 'item'} of ${productName} added to your cart.`,
                  icon: 'success',
                  confirmButtonColor: '#A59D84'
                });
              }
            }
          });
        });
      });
    }

    // Category modal
    async function showCategory(categoryName) {
      const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
      document.getElementById('categoryModalLabel').textContent = categoryName;
      const body = document.getElementById('categoryModalBody');
      body.innerHTML = '<div class="text-center py-4">Loading...</div>';
      try {
        // Ambil id kategori dari API
        const catRes = await fetch(`${BASE_API}/category`);
        const catJson = await catRes.json();
        // Perbaikan di sini: dukung payload array langsung atau di dalam data
        const categories = Array.isArray(catJson.data) ? catJson.data : catJson;
        const cat = (categories || []).find(c => c.name.toLowerCase() === categoryName.toLowerCase());
        if (!cat) {
          body.innerHTML = '<div class="text-center text-danger">Category not found.</div>';
          modal.show();
          return;
        }
        // Ambil produk berdasarkan categoryId
        const prodRes = await fetch(`${BASE_API}/product`);
        const prodJson = await prodRes.json();
        const products = (prodJson.data || []).filter(p => p.Category && p.Category.id === cat.id);
        if (!products.length) {
          body.innerHTML = '<div class="text-center text-muted">No products found in this category.</div>';
        } else {
          // Ganti row menjadi flex container horizontal
          body.innerHTML = products.map(p => `
            <div class="col-md-4 mb-3">
              <div class="card product-card" data-id="${p.id}" data-name="${p.name}" data-price="${p.price}" data-img="${p.image}">
                <img src="${p.image || '/api/placeholder/300/400'}" class="card-img-top" alt="${p.name}">
                <div class="card-body px-0 py-2">
                  <h5 class="card-title">${p.name}</h5>
                  <p class="card-text">${formatRupiah(p.price)}</p>
                </div>
              </div>
            </div>
          `).join('');
        }
        attachProductCardEvents();
      } catch (e) {
        body.innerHTML = '<div class="text-center text-danger">Failed to load products.</div>';
      }
      modal.show();
    }

    // Load Best Seller Products
    async function loadBestSellerProducts() {
      // Ganti id berikut dengan id produk best seller sebenarnya
      const bestSellerIds = ['34', '34']; // contoh id, ganti dengan id produk best seller
      const bestSellerCards = document.querySelectorAll('.bestseller-card');
      
      bestSellerIds.forEach(async (id, i) => {
        if (!bestSellerCards[i]) return;
        
        try {
          const res = await fetch(`${BASE_API}/product/${id}`);
          const json = await res.json();
          if (json.data) {
            const product = json.data;
            const card = bestSellerCards[i];
            
            // Update image
            card.querySelector('img').src = product.image || '/api/placeholder/400/500';
            card.querySelector('img').alt = product.name;
            
            // Update product details
            card.querySelector('.bestseller-title').textContent = product.name;
            card.querySelector('.bestseller-price').textContent = formatRupiah(product.price);
            
            // Set product ID for add to cart button
            card.querySelector('.add-to-cart-bestseller').setAttribute('data-id', product.id);
          }
        } catch (e) {
          console.error('Failed to load bestseller product:', e);
        }
      });
      
      // Attach events to bestseller buttons
      attachBestSellerEvents();
    }

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Check login status on page load
      checkLoginStatus();
      
      // Update cart count on page load
      updateCartCount();
      
      // Latest products
      loadLatestProducts();
      
      // Load best seller products
      loadBestSellerProducts();

      // Category VIEW buttons
      const viewBtns = document.querySelectorAll('.collection-section .view-btn');
      const categories = ['Sneakers', 'Heels', 'Sport'];
      viewBtns.forEach((btn, idx) => {
        btn.onclick = () => showCategory(categories[idx]);
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>